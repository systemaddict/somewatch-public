<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uppy + Transloadit (No Encoding Wait)</title>
    <!-- Pull Uppy from CDN -->
    <link href="https://releases.transloadit.com/uppy/v4.13.3/uppy.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2275d7;
        }
        .upload-container {
            margin: 30px 0;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Uppy + Transloadit</h1>
    <p>Files are processed through your template but without waiting for encoding.</p>
    
    <!-- This div is where the inline Dashboard will appear -->
    <div id="uppy-dashboard" class="upload-container"></div>
    
    <!-- Results area for debugging -->
    <div id="results" class="results">Results will appear here after upload...</div>
    
    <script type="module">
        import {
            Uppy,
            Dashboard,
            ImageEditor,
            RemoteSources,
            Transloadit,
        } from 'https://releases.transloadit.com/uppy/v4.13.3/uppy.min.mjs'
        
        const resultsElement = document.getElementById('results');
        
        const uppy = new Uppy()
            .use(Transloadit, {
                waitForEncoding: false,  // Don't wait for encoding to finish
                alwaysRunAssembly: true,
                assemblyOptions: {
                    params: {
                        template_id: '8244d6bc4eb44148910bf1d493d67b8b',
                        // To avoid tampering, use Signature Authentication:
                        // https://transloadit.com/docs/api/authentication/
                        auth: {
                            key: 'tv2reg',
                        },
                    },
                },
            })
            .use(Dashboard, {
                inline: true,
                target: '#uppy-dashboard',
                height: 450,
                showProgressDetails: true,
                proudlyDisplayPoweredByUppy: true
            })
            .use(ImageEditor, { target: Dashboard })
            .use(RemoteSources, {
                companionUrl: 'https://api2.transloadit.com/companion',
            })
            .on('upload-success', (file, response) => {
                // This event fires when the file is uploaded to Transloadit
                // but before encoding is complete
                console.log('File uploaded successfully:', file.name);
                console.log('Assembly ID:', response.transloadit[0].assembly_id);
                
                resultsElement.textContent = `File uploaded: ${file.name}\n\n` +
                    `Assembly ID: ${response.transloadit[0].assembly_id}\n\n` +
                    `The file is being processed by Transloadit in the background using your template, ` +
                    `but we're not waiting for encoding to complete.`;
            })
            .on('complete', ({ successful }) => {
                console.log('All uploads completed:', successful.length, 'successful files');
            })
            .on('error', (error) => {
                console.error(error);
                resultsElement.textContent = `Error: ${error.message || 'Unknown error'}`;
            });
            
        // Optional: track assembly status separately
        uppy.on('transloadit:assembly-created', (assembly) => {
            console.log('Assembly created:', assembly.assembly_id);
        });
    </script>
</body>
</html>
