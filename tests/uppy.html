<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uppy + Transloadit (No Encoding Wait)</title>
    <!-- Pull Uppy from CDN -->
    <link href="https://releases.transloadit.com/uppy/v4.13.3/uppy.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2275d7;
        }
        .upload-container {
            margin: 30px 0;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>Uppy + Transloadit</h1>
    <p>Files are processed through your template but without waiting for encoding.</p>
    
    <!-- This div is where the inline Dashboard will appear -->
    <div id="uppy-dashboard" class="upload-container"></div>
    
    <!-- Results area for debugging -->
    <div id="results" class="results">Results will appear here after upload...</div>
    
    <script type="module">
        import {
            Uppy,
            Dashboard,
            ImageEditor,
            RemoteSources,
            Transloadit,
        } from 'https://releases.transloadit.com/uppy/v4.13.3/uppy.min.mjs'
        
        const resultsElement = document.getElementById('results');
        
        const uppy = new Uppy()
            .use(Transloadit, {
                waitForEncoding: false,  // Don't wait for encoding to finish
                alwaysRunAssembly: true,
                assemblyOptions: {
                    params: {
                        template_id: '8244d6bc4eb44148910bf1d493d67b8b',
                        auth: {
                            key: 'tv2reg',
                        },
                    },
                },
            })
            .use(Dashboard, {
                inline: true,
                target: '#uppy-dashboard',
                height: 450,
                showProgressDetails: true,
                proudlyDisplayPoweredByUppy: true
            })
            .use(ImageEditor, { target: Dashboard })
            .use(RemoteSources, {
                companionUrl: 'https://api2.transloadit.com/companion',
            })
            .on('upload-success', (file, response) => {
                // Safe debugging - log the entire response structure
                console.log('File uploaded successfully:', file.name);
                console.log('Upload response:', response);
                
                // Display the full response structure to understand what we're getting
                let responseText = `File uploaded: ${file.name}\n\n`;
                responseText += `Response structure:\n${JSON.stringify(response, null, 2)}\n\n`;
                
                // Safe way to extract assembly ID if it exists in the expected structure
                let assemblyId = "Unknown";
                try {
                    if (response.transloadit && 
                        Array.isArray(response.transloadit) && 
                        response.transloadit.length > 0 &&
                        response.transloadit[0].assembly_id) {
                            assemblyId = response.transloadit[0].assembly_id;
                    } else if (response.assembly_id) {
                        assemblyId = response.assembly_id;
                    } else if (typeof response === 'object') {
                        // Try to find assembly_id anywhere in the response
                        const findAssemblyId = (obj) => {
                            for (const key in obj) {
                                if (key === 'assembly_id') return obj[key];
                                if (typeof obj[key] === 'object' && obj[key] !== null) {
                                    const result = findAssemblyId(obj[key]);
                                    if (result) return result;
                                }
                            }
                            return null;
                        };
                        const foundId = findAssemblyId(response);
                        if (foundId) assemblyId = foundId;
                    }
                } catch (err) {
                    console.error('Error extracting assembly ID:', err);
                }
                
                responseText += `Assembly ID: ${assemblyId}\n\n`;
                responseText += `The file is being processed by Transloadit in the background.`;
                
                resultsElement.textContent = responseText;
            })
            .on('transloadit:assembly-created', (assembly) => {
                console.log('Assembly created:', assembly);
                resultsElement.textContent += `\n\nAssembly created: ${assembly.assembly_id}`;
            })
            .on('complete', ({ successful, failed }) => {
                console.log('All uploads completed:', successful.length, 'successful files');
                console.log('Failed uploads:', failed.length);
                
                if (failed.length > 0) {
                    console.error('Failed files:', failed);
                }
            })
            .on('error', (error) => {
                console.error('Error:', error);
                resultsElement.textContent = `Error: ${error.message || 'Unknown error'}`;
            });
    </script>
</body>
</html>
